const e=300,t="https://stackblitz.com",n=["angular-cli","create-react-app","html","javascript","node","polymer","typescript","vue"],i=["project","search","ports","settings"],r=["light","dark"],o=["editor","preview"],s={clickToLoad:e=>a("ctl",e),devToolsHeight:e=>d("devtoolsheight",e),forceEmbedLayout:e=>a("embed",e),hideDevTools:e=>a("hidedevtools",e),hideExplorer:e=>a("hideExplorer",e),hideNavigation:e=>a("hideNavigation",e),openFile:e=>p("file",e),showSidebar:e=>function(e,t){if("boolean"==typeof t)return`${e}=${t?"1":"0"}`;return""}("showSidebar",e),sidebarView:e=>l("sidebarView",e,i),startScript:e=>p("startScript",e),terminalHeight:e=>d("terminalHeight",e),theme:e=>l("theme",e,r),view:e=>l("view",e,o),zenMode:e=>a("zenMode",e),organization:e=>`${p("orgName",e?.name)}&${p("orgProvider",e?.provider)}`,crossOriginIsolated:e=>a("corp",e)};function c(e={}){const t=Object.entries(e).map((([e,t])=>null!=t&&s.hasOwnProperty(e)?s[e](t):"")).filter(Boolean);return t.length?`?${t.join("&")}`:""}function a(e,t){return!0===t?`${e}=1`:""}function d(e,t){if("number"==typeof t&&!Number.isNaN(t)){const n=Math.min(100,Math.max(0,t));return`${e}=${encodeURIComponent(Math.round(n))}`}return""}function l(e,t="",n=[]){return n.includes(t)?`${e}=${encodeURIComponent(t)}`:""}function p(e,t){return(Array.isArray(t)?t:[t]).filter((e=>"string"==typeof e&&""!==e.trim())).map((t=>`${e}=${encodeURIComponent(t)}`)).join("&")}function u(){return Math.random().toString(36).slice(2,6)+Math.random().toString(36).slice(2,6)}function h(e,t){return`${f(t)}${e}${c(t)}`}function m(e,t){const n={forceEmbedLayout:!0};return t&&"object"==typeof t&&Object.assign(n,t),`${f(n)}${e}${c(n)}`}function f(e={}){return("string"==typeof e.origin?e.origin:t).replace(/\/$/,"")}function g(t,n,i){if(!n||!t||!t.parentNode)throw new Error("Invalid Element");t.id&&(n.id=t.id),t.className&&(n.className=t.className),function(t,n={}){const i=Object.hasOwnProperty.call(n,"height")?`${n.height}`:`${e}`,r=Object.hasOwnProperty.call(n,"width")?`${n.width}`:void 0;t.setAttribute("height",i),r?t.setAttribute("width",r):t.setAttribute("style","width:100%;")}(n,i),function(e,t,n={}){const i=e.allow?.split(";")?.map((e=>e.trim()))??[];n.crossOriginIsolated&&!i.includes("cross-origin-isolated")&&i.push("cross-origin-isolated");i.length>0&&(t.allow=i.join("; "))}(t,n,i),t.replaceWith(n)}function y(e){if("string"==typeof e){const t=document.getElementById(e);if(!t)throw new Error(`Could not find element with id '${e}'`);return t}if(e instanceof HTMLElement)return e;throw new Error(`Invalid element: ${e}`)}function w(e){return e&&!1===e.newWindow?"_self":"_blank"}class _{constructor(e){this.pending={},this.port=e,this.port.onmessage=this.messageListener.bind(this)}request({type:e,payload:t}){return new Promise(((n,i)=>{const r=u();this.pending[r]={resolve:n,reject:i},this.port.postMessage({type:e,payload:{...t,__reqid:r}})}))}messageListener(e){if("string"!=typeof e.data.payload?.__reqid)return;const{type:t,payload:n}=e.data,{__reqid:i,__success:r,__error:o}=n;this.pending[i]&&(r?this.pending[i].resolve(this.cleanResult(n)):this.pending[i].reject(o?`${t}: ${o}`:t),delete this.pending[i])}cleanResult(e){const t={...e};return delete t.__reqid,delete t.__success,delete t.__error,Object.keys(t).length?t:null}}class b{constructor(e,t){this.editor={openFile:e=>this._rdc.request({type:"SDK_OPEN_FILE",payload:{path:e}}),setCurrentFile:e=>this._rdc.request({type:"SDK_SET_CURRENT_FILE",payload:{path:e}}),setTheme:e=>this._rdc.request({type:"SDK_SET_UI_THEME",payload:{theme:e}}),setView:e=>this._rdc.request({type:"SDK_SET_UI_VIEW",payload:{view:e}}),showSidebar:(e=!0)=>this._rdc.request({type:"SDK_TOGGLE_SIDEBAR",payload:{visible:e}})},this.preview={origin:"",getUrl:()=>this._rdc.request({type:"SDK_GET_PREVIEW_URL",payload:{}}).then((e=>e?.url??null)),setUrl:(e="/")=>{if("string"!=typeof e||!e.startsWith("/"))throw new Error(`Invalid argument: expected a path starting with '/', got '${e}'`);return this._rdc.request({type:"SDK_SET_PREVIEW_URL",payload:{path:e}})}},this._rdc=new _(e),Object.defineProperty(this.preview,"origin",{value:"string"==typeof t.previewOrigin?t.previewOrigin:null,writable:!1})}applyFsDiff(e){const t=e=>null!==e&&"object"==typeof e;if(!t(e)||!t(e.create))throw new Error("Invalid diff object: expected diff.create to be an object.");if(!Array.isArray(e.destroy))throw new Error("Invalid diff object: expected diff.destroy to be an array.");return this._rdc.request({type:"SDK_APPLY_FS_DIFF",payload:e})}getDependencies(){return this._rdc.request({type:"SDK_GET_DEPS_SNAPSHOT",payload:{}})}getFsSnapshot(){return this._rdc.request({type:"SDK_GET_FS_SNAPSHOT",payload:{}})}}const E=[];class v{constructor(e){this.id=u(),this.element=e,this.pending=new Promise(((e,t)=>{const n=({data:t,ports:n})=>{"SDK_INIT_SUCCESS"===t?.action&&t.id===this.id&&(this.vm=new b(n[0],t.payload),e(this.vm),r())},i=()=>{this.element.contentWindow?.postMessage({action:"SDK_INIT",id:this.id},"*")};function r(){window.clearInterval(s),window.removeEventListener("message",n)}window.addEventListener("message",n),i();let o=0;const s=window.setInterval((()=>{if(this.vm)r();else{if(o>=20)return r(),t("Timeout: Unable to establish a connection with the StackBlitz VM"),void E.forEach(((e,t)=>{e.id===this.id&&E.splice(t,1)}));o++,i()}}),500)})),E.push(this)}}const S=e=>{const t=e instanceof Element?"element":"id";return E.find((n=>n[t]===e))??null};function j({template:e,title:t,description:i,dependencies:r,files:o,settings:s}){if(!n.includes(e)){const e=n.map((e=>`'${e}'`)).join(", ");console.warn(`Unsupported project.template: must be one of ${e}`)}const c=[],a=(e,t,n="")=>{c.push(function(e,t){const n=document.createElement("input");return n.type="hidden",n.name=e,n.value=t,n}(e,"string"==typeof t?t:n))};a("project[title]",t),"string"==typeof i&&i.length>0&&a("project[description]",i),a("project[template]",e,"javascript"),r&&("node"===e?console.warn("Invalid project.dependencies: dependencies must be provided as a 'package.json' file when using the 'node' template."):a("project[dependencies]",JSON.stringify(r))),s&&a("project[settings]",JSON.stringify(s)),Object.entries(o).forEach((([e,t])=>{a(`project[files][${function(e){return e.replace(/\[/g,"%5B").replace(/\]/g,"%5D")}(e)}]`,t)}));const d=document.createElement("form");return d.method="POST",d.setAttribute("style","display:none!important;"),d.append(...c),d}function $(e){if(!e?.contentWindow)return Promise.reject("Provided element is not an iframe.");return(S(e)??new v(e)).pending}const I={connect:$,embedGithubProject:function(e,t,n){const i=y(e),r=document.createElement("iframe");return r.src=m(`/github/${t}`,n),g(i,r,n),$(r)},embedProject:function(e,t,n){const i=y(e),r=function(e,t){const n=j(e);return n.action=m("/run",t),n.id="sb_run",`<!doctype html>\n<html>\n<head><title></title></head>\n<body>\n  ${n.outerHTML}\n  <script>document.getElementById('${n.id}').submit();<\/script>\n</body>\n</html>`}(t,n),o=document.createElement("iframe");return g(i,o,n),o.contentDocument?.write(r),$(o)},embedProjectId:function(e,t,n){const i=y(e),r=document.createElement("iframe");return r.src=m(`/edit/${t}`,n),g(i,r,n),$(r)},openGithubProject:function(e,t){const n=h(`/github/${e}`,t),i=w(t);window.open(n,i)},openProject:function(e,t){!function(e,t){const n=j(e);n.action=h("/run",t),n.target=w(t),document.body.appendChild(n),n.submit(),document.body.removeChild(n)}(e,t)},openProjectId:function(e,t){const n=h(`/edit/${e}`,t),i=w(t);window.open(n,i)}},P=document.getElementById("embed"),T=JSON.parse(document.getElementById("stackblitz-project").textContent);I.embedProject(P,T,{height:window.innerHeight+"px",openFile:"index.ts",terminalHeight:0,devToolsHeight:50,hideNavigation:!0,showSidebar:!0}),requestAnimationFrame((()=>{P.style.visibility="visible"}));
